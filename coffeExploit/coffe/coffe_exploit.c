#include <iostream>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <string.h>
#include <getopt.h>

#include "nfc.hpp"

void print_usage(const char *pcProgramName) {
	printf("Usage: ");
	printf("%s <key> [new credit]\n", pcProgramName);
	printf("  enter the 6 bytes key in hexadecimal (ex : AABBCCDDEEFF)\n");
	printf("  enter the new credit to put on the nfc tag (optional)\n");
}

int main(int argc, char **argv) {
    if(argc < 2){
        print_usage(argv[0]);
		return EXIT_SUCCESS;
	}
       
    char *str, *end;
    errno = 0;
    uint64_t result = strtoull(argv[1], &end, 16);
    if (result == 0 && end == str) {
        //str was not a number
        fprintf(stderr,"invalid key: not an number!\n");
        return EXIT_FAILURE;
    }   
    
    uint8_t key[6];
    for(int i = 0; i < 6; i++){
        key[5-i] = result & 0xFF;
        result >>= 8;
    }
    fprintf(stderr,"key = ");
    for(int i = 0; i < 6; i++){
        fprintf(stderr,"0x%02x ", key[i]);
    }
    fprintf(stderr,"\n");
    
	Nfc nfc;
	
	//uint8_t keyB[6] = { 0x7D, 0x09, 0x83, 0x7B, 0xED, 0x81};	
		
	bool success = nfc.authenticate(45, key, 'B');
	if(success){
		uint8_t data[16];
		
		if(nfc.read(45, data)){
			uint16_t value = (data[9] << 8) | data[10];
			double credit = ((double)value) / 100;
			fprintf(stderr, "Credit : %2.2f euros (0x%x)\n", credit, value);
		}
		
        if(argc >= 3){
            double d = strtod (argv[2], &end);
            uint16_t newCredit = (uint16_t)(d * 100);
            
            data[9] = (newCredit >> 8);
            data[10] = (newCredit & 0xff);
            
            nfc.write(45, data);
            nfc.read(45, data);

            fprintf(stderr, "New credit : %2.2f euros (0x%x)\n", d, newCredit);
        }
	}else{
		fprintf(stderr, "This is not the correct key !!\n");
	}

	return EXIT_SUCCESS;
}

